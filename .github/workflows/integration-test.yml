name: Integration Test and Deploy

on:
  # ìˆ˜ë™ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:
    inputs:
      deploy_to_ec2:
        description: 'EC2ì— ë°°í¬í• ê¹Œìš”?'
        required: false
        type: boolean
        default: false

  # User ë˜ëŠ” Board ì„œë¹„ìŠ¤ì—ì„œ ìƒˆ ì´ë¯¸ì§€ê°€ í‘¸ì‹œë˜ë©´ ìë™ ì‹¤í–‰ (webhook í•„ìš”)
  repository_dispatch:
    types: [new-image-pushed]

env:
  USER_IMAGE: ressbe/wealist-user:latest
  BOARD_IMAGE: ressbe/wealist-board:latest

jobs:
  integration-test:
    name: í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ìµœì‹  ì´ë¯¸ì§€ Pull
        run: |
          echo "ğŸ“¦ ìµœì‹  Docker ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
          docker pull ${{ env.USER_IMAGE }}
          docker pull ${{ env.BOARD_IMAGE }}

      - name: .env íŒŒì¼ ìƒì„±
        run: |
          cat << EOF > .env
          APP_NAME=weAlist
          POSTGRES_SUPERUSER=postgres
          POSTGRES_SUPERUSER_PASSWORD=test_password
          USER_DB_NAME=wealist_user_db
          USER_DB_USER=user_service
          USER_DB_PASSWORD=user_password
          KANBAN_DB_NAME=wealist_kanban_db
          KANBAN_DB_USER=kanban_service
          KANBAN_DB_PASSWORD=kanban_password
          REDIS_PASSWORD=test_redis_password
          JWT_SECRET=test-super-secret-jwt-key-for-integration-test
          JWT_EXPIRATION_MS=86400000
          JWT_ACCESS_MS=1800000
          JPA_DDL_AUTO=update
          JPA_SHOW_SQL=true
          JPA_FORMAT_SQL=true
          CORS_ORIGINS=http://localhost:3000,http://localhost:8000,http://localhost:8081
          EOF

      - name: ì»¨í…Œì´ë„ˆ ì‹œì‘
        run: |
          echo "ğŸš€ Docker Composeë¡œ ì„œë¹„ìŠ¤ ì‹œì‘..."
          docker compose up -d

      - name: ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸°
        run: |
          echo "â³ ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° ì¤‘ (60ì´ˆ)..."
          sleep 60

      - name: Health Check
        run: |
          echo "ğŸ¥ Health Check ìˆ˜í–‰ ì¤‘..."

          # PostgreSQL
          if docker exec wealist-postgres pg_isready -U postgres; then
            echo "âœ… PostgreSQL ì •ìƒ"
          else
            echo "âŒ PostgreSQL ì‹¤íŒ¨"
            exit 1
          fi

          # Redis
          if docker exec wealist-redis redis-cli ping; then
            echo "âœ… Redis ì •ìƒ"
          else
            echo "âŒ Redis ì‹¤íŒ¨"
            exit 1
          fi

          # User Service
          MAX_RETRY=10
          RETRY=0
          while [ $RETRY -lt $MAX_RETRY ]; do
            if curl -f http://localhost:8081/health; then
              echo "âœ… User Service ì •ìƒ"
              break
            fi
            RETRY=$((RETRY+1))
            echo "ì¬ì‹œë„ ì¤‘... ($RETRY/$MAX_RETRY)"
            sleep 5
          done

          if [ $RETRY -eq $MAX_RETRY ]; then
            echo "âŒ User Service ì‹¤íŒ¨"
            docker compose logs user-service
            exit 1
          fi

          # Kanban Service
          RETRY=0
          while [ $RETRY -lt $MAX_RETRY ]; do
            if curl -f http://localhost:8000/health; then
              echo "âœ… Kanban Service ì •ìƒ"
              break
            fi
            RETRY=$((RETRY+1))
            echo "ì¬ì‹œë„ ì¤‘... ($RETRY/$MAX_RETRY)"
            sleep 5
          done

          if [ $RETRY -eq $MAX_RETRY ]; then
            echo "âŒ Kanban Service ì‹¤íŒ¨"
            docker compose logs kanban-service
            exit 1
          fi

      - name: í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          echo "ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."

          # User Service API í…ŒìŠ¤íŠ¸ (ì˜ˆì‹œ)
          echo "Testing User Service endpoints..."
          # curl -X POST http://localhost:8081/api/auth/register ...

          # Kanban Service API í…ŒìŠ¤íŠ¸ (ì˜ˆì‹œ)
          echo "Testing Kanban Service endpoints..."
          # curl -X GET http://localhost:8000/api/workspaces ...

          echo "âœ… í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼"

      - name: ë¡œê·¸ ì¶œë ¥ (ì‹¤íŒ¨ ì‹œ)
        if: failure()
        run: |
          echo "ğŸ“ ì„œë¹„ìŠ¤ ë¡œê·¸ ì¶œë ¥..."
          docker compose logs

      - name: ì»¨í…Œì´ë„ˆ ì •ë¦¬
        if: always()
        run: |
          echo "ğŸ§¹ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
          docker compose down -v

  deploy-to-ec2:
    name: EC2 ë°°í¬
    needs: integration-test
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_to_ec2 == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SSH í‚¤ ì„¤ì •
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2-key.pem
          chmod 600 ec2-key.pem

      - name: .env íŒŒì¼ ìƒì„±
        run: |
          cat << EOF > .env
          APP_NAME=${{ secrets.APP_NAME }}
          POSTGRES_SUPERUSER=${{ secrets.POSTGRES_SUPERUSER }}
          POSTGRES_SUPERUSER_PASSWORD=${{ secrets.POSTGRES_SUPERUSER_PASSWORD }}
          USER_DB_NAME=${{ secrets.USER_DB_NAME }}
          USER_DB_USER=${{ secrets.USER_DB_USER }}
          USER_DB_PASSWORD=${{ secrets.USER_DB_PASSWORD }}
          KANBAN_DB_NAME=${{ secrets.KANBAN_DB_NAME }}
          KANBAN_DB_USER=${{ secrets.KANBAN_DB_USER }}
          KANBAN_DB_PASSWORD=${{ secrets.KANBAN_DB_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRATION_MS=${{ secrets.JWT_EXPIRATION_MS }}
          JWT_ACCESS_MS=${{ secrets.JWT_ACCESS_MS }}
          JPA_DDL_AUTO=${{ secrets.JPA_DDL_AUTO }}
          JPA_SHOW_SQL=${{ secrets.JPA_SHOW_SQL }}
          JPA_FORMAT_SQL=${{ secrets.JPA_FORMAT_SQL }}
          CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
          EOF

      - name: EC2 ë°°í¬ ì‹¤í–‰
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          EC2_KEY=./ec2-key.pem ./deploy-to-ec2.sh

      - name: SSH í‚¤ ì •ë¦¬
        if: always()
        run: rm -f ec2-key.pem

  notify-discord:
    name: Discord ì•Œë¦¼
    needs: integration-test
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'repository_dispatch'

    steps:
      - name: Set notification color
        id: color
        run: |
          if [ "${{ needs.integration-test.result }}" == "success" ]; then
            echo "color=3066993" >> $GITHUB_OUTPUT  # Green
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "status=ì„±ê³µ" >> $GITHUB_OUTPUT
          else
            echo "color=15158332" >> $GITHUB_OUTPUT  # Red
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "status=ì‹¤íŒ¨" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification
        if: needs.integration-test.result == 'success'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ğŸš€ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ",
                "description": "í†µí•© í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!",
                "color": '${{ steps.color.outputs.color }}',
                "fields": [
                  {
                    "name": "ì„œë¹„ìŠ¤",
                    "value": "`${{ github.event.client_payload.service }}`",
                    "inline": true
                  },
                  {
                    "name": "ë²„ì „",
                    "value": "`${{ github.event.client_payload.version }}`",
                    "inline": true
                  },
                  {
                    "name": "í‘¸ì‹œí•œ ì‚¬ëŒ",
                    "value": "@${{ github.event.client_payload.actor }}",
                    "inline": true
                  },
                  {
                    "name": "ì»¤ë°‹",
                    "value": "`${{ github.event.client_payload.commit }}`",
                    "inline": false
                  },
                  {
                    "name": "${{ steps.color.outputs.emoji }} í†µí•© í…ŒìŠ¤íŠ¸",
                    "value": "${{ steps.color.outputs.status }}",
                    "inline": false
                  },
                  {
                    "name": "ğŸ“¦ ë‹¤ìŒ ë‹¨ê³„",
                    "value": "EC2 ë°°í¬ë¥¼ ì›í•˜ì‹œë©´ [GitHub Actionsì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰](https://github.com/ressKim-io/wealist-deploy-test/actions)í•˜ì„¸ìš”.\n\n**Actions â†’ Integration Test and Deploy â†’ Run workflow â†’ âœ… deploy_to_ec2**",
                    "inline": false
                  }
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'

      - name: Send Discord notification (failure)
        if: needs.integration-test.result != 'success'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨",
                "description": "ë°°í¬ë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
                "color": '${{ steps.color.outputs.color }}',
                "fields": [
                  {
                    "name": "ì„œë¹„ìŠ¤",
                    "value": "`${{ github.event.client_payload.service }}`",
                    "inline": true
                  },
                  {
                    "name": "ë²„ì „",
                    "value": "`${{ github.event.client_payload.version }}`",
                    "inline": true
                  },
                  {
                    "name": "í‘¸ì‹œí•œ ì‚¬ëŒ",
                    "value": "@${{ github.event.client_payload.actor }}",
                    "inline": true
                  },
                  {
                    "name": "ì»¤ë°‹",
                    "value": "`${{ github.event.client_payload.commit }}`",
                    "inline": false
                  },
                  {
                    "name": "ğŸ” ë¡œê·¸ í™•ì¸",
                    "value": "[GitHub Actions ë¡œê·¸ ë³´ê¸°](https://github.com/ressKim-io/wealist-deploy-test/actions)",
                    "inline": false
                  }
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
