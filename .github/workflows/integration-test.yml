name: Integration Test and Deploy

on:
  # ìˆ˜ë™ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:
    inputs:
      deploy_to_ec2:
        description: 'EC2ì— ë°°í¬í• ê¹Œìš”?'
        required: false
        type: boolean
        default: false

  # User ë˜ëŠ” Board ì„œë¹„ìŠ¤ì—ì„œ ìƒˆ ì´ë¯¸ì§€ê°€ í‘¸ì‹œë˜ë©´ ìë™ ì‹¤í–‰ (webhook í•„ìš”)
  repository_dispatch:
    types: [new-image-pushed]

env:
  USER_IMAGE_TAG: ${{ github.event.client_payload.user_image_tag || 'latest' }}
  KANBAN_IMAGE_TAG: ${{ github.event.client_payload.kanban_image_tag || 'latest' }}

jobs:
  integration-test:
    name: í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: .env íŒŒì¼ ìƒì„±
        run: |
          cat << EOF > .env
          APP_NAME=weAlist
          POSTGRES_SUPERUSER=postgres
          POSTGRES_SUPERUSER_PASSWORD=test_password
          USER_DB_NAME=wealist_user_db
          USER_DB_USER=user_service
          USER_DB_PASSWORD=user_password
          KANBAN_DB_NAME=wealist_kanban_db
          KANBAN_DB_USER=kanban_service
          KANBAN_DB_PASSWORD=kanban_password
          REDIS_PASSWORD=test_redis_password
          JWT_SECRET=test-super-secret-jwt-key-for-integration-test
          JWT_EXPIRATION_MS=86400000
          JWT_ACCESS_MS=1800000
          JPA_DDL_AUTO=update
          JPA_SHOW_SQL=true
          JPA_FORMAT_SQL=true
          CORS_ORIGINS=http://localhost:3000,http://localhost:8000,http://localhost:8081
          EOF

      - name: ì»¨í…Œì´ë„ˆ ì‹œì‘
        run: |
          echo "ğŸš€ Docker Composeë¡œ ì„œë¹„ìŠ¤ ì‹œì‘..."
          docker compose up -d

      - name: ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° ë° Health Check
        run: |
          echo "ğŸ¥ ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° ë° Health Check ìˆ˜í–‰ ì¤‘..."

          check_service_health() {
              local service_name=$1
              local url=$2
              local max_retry=${3:-20}
              local retry=0

              echo "${service_name} ìƒíƒœ í™•ì¸ ì¤‘..."
              while [ $retry -lt $max_retry ]; do
                  if curl -f -s "$url" > /dev/null 2>&1; then
                      echo "âœ… ${service_name} ì •ìƒ ë™ì‘"
                      return 0
                  fi
                  retry=$((retry+1))
                  echo "${service_name} ì¬ì‹œë„ ì¤‘... ($retry/$max_retry)"
                  sleep 3
              done

              echo "âŒ ${service_name} ì‘ë‹µ ì—†ìŒ - ë¡œê·¸ í™•ì¸"
              docker logs wealist-${service_name,,}-service --tail 20
              return 1
          }

          # PostgreSQL
          if ! docker exec wealist-postgres pg_isready -U postgres; then
            echo "âŒ PostgreSQL ì‹¤íŒ¨"
            docker logs wealist-postgres --tail 20
            exit 1
          fi
          echo "âœ… PostgreSQL ì •ìƒ"

          # Redis (ë¹„ë°€ë²ˆí˜¸ í¬í•¨)
          if ! docker exec wealist-redis redis-cli -a "test_redis_password" ping; then
            echo "âŒ Redis ì‹¤íŒ¨"
            docker logs wealist-redis --tail 20
            exit 1
          fi
          echo "âœ… Redis ì •ìƒ"

          # User Service health check
          if ! check_service_health "User Service" "http://localhost:8081/health" 20; then
              exit 1
          fi

          # Kanban Service health check
          if ! check_service_health "Kanban Service" "http://localhost:8000/health" 20; then
              exit 1
          fi

      - name: í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          echo "ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."

          # User Service API í…ŒìŠ¤íŠ¸
          echo "Testing User Service endpoints..."
          if curl -f -s http://localhost:8081/health > /dev/null; then
            echo "âœ… User Service API ì ‘ê·¼ ê°€ëŠ¥"
          else
            echo "âŒ User Service API ì ‘ê·¼ ì‹¤íŒ¨"
            exit 1
          fi

          # Kanban Service API í…ŒìŠ¤íŠ¸
          echo "Testing Kanban Service endpoints..."
          if curl -f -s http://localhost:8000/health > /dev/null; then
            echo "âœ… Kanban Service API ì ‘ê·¼ ê°€ëŠ¥"
          else
            echo "âŒ Kanban Service API ì ‘ê·¼ ì‹¤íŒ¨"
            exit 1
          fi

          echo "âœ… í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼"

      - name: ë¡œê·¸ ì¶œë ¥ (ì‹¤íŒ¨ ì‹œ)
        if: failure()
        run: |
          echo "ğŸ“ ì„œë¹„ìŠ¤ ë¡œê·¸ ì¶œë ¥..."
          echo "=== User Service ë¡œê·¸ ==="
          docker logs wealist-user-service --tail 50
          echo "=== Kanban Service ë¡œê·¸ ==="
          docker logs wealist-kanban-service --tail 50
          echo "=== PostgreSQL ë¡œê·¸ ==="
          docker logs wealist-postgres --tail 30
          echo "=== Redis ë¡œê·¸ ==="
          docker logs wealist-redis --tail 30
          echo "=== Docker Compose ìƒíƒœ ==="
          docker compose ps

      - name: ì»¨í…Œì´ë„ˆ ì •ë¦¬
        if: always()
        run: |
          echo "ğŸ§¹ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
          docker compose down -v

  deploy-to-ec2:
    name: EC2 ë°°í¬
    needs: integration-test
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_to_ec2 == 'true'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SSH í‚¤ ì„¤ì •
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2-key.pem
          chmod 600 ec2-key.pem

      - name: .env íŒŒì¼ ìƒì„±
        run: |
          cat << EOF > .env
          APP_NAME=${{ secrets.APP_NAME }}
          POSTGRES_SUPERUSER=${{ secrets.POSTGRES_SUPERUSER }}
          POSTGRES_SUPERUSER_PASSWORD=${{ secrets.POSTGRES_SUPERUSER_PASSWORD }}
          USER_DB_NAME=${{ secrets.USER_DB_NAME }}
          USER_DB_USER=${{ secrets.USER_DB_USER }}
          USER_DB_PASSWORD=${{ secrets.USER_DB_PASSWORD }}
          KANBAN_DB_NAME=${{ secrets.KANBAN_DB_NAME }}
          KANBAN_DB_USER=${{ secrets.KANBAN_DB_USER }}
          KANBAN_DB_PASSWORD=${{ secrets.KANBAN_DB_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRATION_MS=${{ secrets.JWT_EXPIRATION_MS }}
          JWT_ACCESS_MS=${{ secrets.JWT_ACCESS_MS }}
          JPA_DDL_AUTO=${{ secrets.JPA_DDL_AUTO }}
          JPA_SHOW_SQL=${{ secrets.JPA_SHOW_SQL }}
          JPA_FORMAT_SQL=${{ secrets.JPA_FORMAT_SQL }}
          CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
          EOF

      - name: EC2 ë°°í¬ ì‹¤í–‰
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          EC2_KEY=./ec2-key.pem ./deploy-to-ec2.sh

      - name: SSH í‚¤ ì •ë¦¬
        if: always()
        run: rm -f ec2-key.pem

  notify-discord:
    name: Discord ì•Œë¦¼
    needs: integration-test
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'repository_dispatch'

    steps:
      - name: Set notification color
        id: color
        run: |
          if [ "${{ needs.integration-test.result }}" == "success" ]; then
            echo "color=3066993" >> $GITHUB_OUTPUT  # Green
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "status=ì„±ê³µ" >> $GITHUB_OUTPUT
          else
            echo "color=15158332" >> $GITHUB_OUTPUT  # Red
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "status=ì‹¤íŒ¨" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification
        if: needs.integration-test.result == 'success'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ğŸš€ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ",
                "description": "í†µí•© í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!",
                "color": '${{ steps.color.outputs.color }}',
                "fields": [
                  {
                    "name": "ì„œë¹„ìŠ¤",
                    "value": "`${{ github.event.client_payload.service }}`",
                    "inline": true
                  },
                  {
                    "name": "ë²„ì „",
                    "value": "`${{ github.event.client_payload.version }}`",
                    "inline": true
                  },
                  {
                    "name": "í‘¸ì‹œí•œ ì‚¬ëŒ",
                    "value": "@${{ github.event.client_payload.actor }}",
                    "inline": true
                  },
                  {
                    "name": "ì»¤ë°‹",
                    "value": "`${{ github.event.client_payload.commit }}`",
                    "inline": false
                  },
                  {
                    "name": "${{ steps.color.outputs.emoji }} í†µí•© í…ŒìŠ¤íŠ¸",
                    "value": "${{ steps.color.outputs.status }}",
                    "inline": false
                  },
                  {
                    "name": "ğŸ“¦ ë‹¤ìŒ ë‹¨ê³„",
                    "value": "EC2 ë°°í¬ë¥¼ ì›í•˜ì‹œë©´ [GitHub Actionsì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰](https://github.com/ressKim-io/wealist-deploy-test/actions)í•˜ì„¸ìš”.\n\n**Actions â†’ Integration Test and Deploy â†’ Run workflow â†’ âœ… deploy_to_ec2**",
                    "inline": false
                  }
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'

      - name: Send Discord notification (failure)
        if: needs.integration-test.result != 'success'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨",
                "description": "ë°°í¬ë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
                "color": '${{ steps.color.outputs.color }}',
                "fields": [
                  {
                    "name": "ì„œë¹„ìŠ¤",
                    "value": "`${{ github.event.client_payload.service }}`",
                    "inline": true
                  },
                  {
                    "name": "ë²„ì „",
                    "value": "`${{ github.event.client_payload.version }}`",
                    "inline": true
                  },
                  {
                    "name": "í‘¸ì‹œí•œ ì‚¬ëŒ",
                    "value": "@${{ github.event.client_payload.actor }}",
                    "inline": true
                  },
                  {
                    "name": "ì»¤ë°‹",
                    "value": "`${{ github.event.client_payload.commit }}`",
                    "inline": false
                  },
                  {
                    "name": "ğŸ” ë¡œê·¸ í™•ì¸",
                    "value": "[GitHub Actions ë¡œê·¸ ë³´ê¸°](https://github.com/ressKim-io/wealist-deploy-test/actions)",
                    "inline": false
                  }
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
